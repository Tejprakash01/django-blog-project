{% extends "blog/base.html" %}
{% block content %}

<style>
  #chat-log {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 450px;
    overflow-y: auto;
    padding: 10px;
  }

  .chat-msg {
    max-width: 60%;
    padding: 8px 12px;
    border-radius: 10px;
    font-size: 14px;
    word-wrap: break-word;
  }

  .chat-me {
    align-self: flex-end;
    background-color: #dcf8c6;
    color: #1f2937;
    text-align: right;
  }

  .chat-other {
    align-self: flex-start;
    background-color: #f1f0f0;
    color: #1f2937;
    text-align: left;
  }

  .chat-input-container {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }

  #chat-message-input {
    flex: 1;
    padding: 8px;
  }
</style>

<div class="page chat-room">
  <h2>üí¨ Chat</h2>

  <div id="chat-log">
    {% for msg in messages %}
      <div class="chat-msg {% if msg.sender == request.user %}chat-me{% else %}chat-other{% endif %}">
        {{ msg.content }}
      </div>
    {% endfor %}
  </div>

  <div class="chat-input-container">
    <input id="chat-message-input" type="text" placeholder="Type your message...">
    <button id="chat-message-submit">Send</button>
  </div>
</div>

<script>
const roomId = "{{ room.id }}";
const currentUser = "{{ request.user.username }}";

const protocol = window.location.protocol === "https:" ? "wss" : "ws";
const chatSocket = new WebSocket(
  `${protocol}://${window.location.host}/ws/chat/${roomId}/`
);

chatSocket.onopen = () => {
  console.log("‚úÖ WebSocket connected");
};

chatSocket.onmessage = function (e) {
  const data = JSON.parse(e.data);
  const chatLog = document.getElementById("chat-log");

  const msgDiv = document.createElement("div");
  msgDiv.classList.add("chat-msg");

  if (data.user === currentUser) {
    msgDiv.classList.add("chat-me");
  } else {
    msgDiv.classList.add("chat-other");
  }

  msgDiv.textContent = data.message;

  chatLog.appendChild(msgDiv);
  chatLog.scrollTop = chatLog.scrollHeight;
};

chatSocket.onclose = function () {
  console.error("‚ùå WebSocket closed");
};

document.getElementById("chat-message-submit").onclick = function () {
  const input = document.getElementById("chat-message-input");
  const message = input.value.trim();

  if (message !== "") {
    chatSocket.send(JSON.stringify({
      message: message
    }));
    input.value = "";
  }
};

document.getElementById("chat-message-input").addEventListener("keypress", function (e) {
  if (e.key === "Enter") {
    document.getElementById("chat-message-submit").click();
  }
});
</script>

{% endblock %}
