{% extends "blog/base.html" %}

{% block title %}Chat - MyBlog{% endblock %}

{% block content %}
<div class="page chat-room">
    <h2>üí¨ Chat</h2>

    <div id="chat-box">
        {% for msg in messages %}
            <p><b>{{ msg.sender.username }}:</b> {{ msg.text }}</p>
        {% endfor %}
    </div>

    <div class="chat-input-container">
        <input id="message-input" type="text" placeholder="Type your message..." autocomplete="off">
        <button id="send-btn">Send</button>
    </div>
</div>

<script>
const roomId = "{{ room.id }}";

// Auto-detect ws / wss
const protocol = window.location.protocol === "https:" ? "wss" : "ws";
const socket = new WebSocket(
    `${protocol}://${window.location.host}/ws/chat/${roomId}/`
);

const chatBox = document.getElementById("chat-box");
const messageInput = document.getElementById("message-input");
const sendBtn = document.getElementById("send-btn");

socket.onopen = function () {
    console.log("‚úÖ WebSocket connected");
};

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    chatBox.innerHTML += `<p><b>${data.username}:</b> ${data.message}</p>`;
    chatBox.scrollTop = chatBox.scrollHeight;
};

socket.onerror = function(e) {
    console.error("‚ùå WebSocket error", e);
};

socket.onclose = function() {
    console.warn("‚ö†Ô∏è WebSocket closed");
};

// Focus input on load
messageInput.focus();

// Enter key sends message
messageInput.addEventListener("keyup", function(e) {
    if (e.key === "Enter") sendMessage();
});

sendBtn.onclick = sendMessage;

function sendMessage() {
    const msg = messageInput.value.trim();
    if (!msg) return;

    socket.send(JSON.stringify({ message: msg }));
    messageInput.value = "";
}
</script>

{% endblock %}