{% extends "blog/base.html" %}

{% block title %}Chat - MyBlog{% endblock %}

{% block content %}
<div class="page chat-room">
    <h2>üí¨ Chat</h2>

    <div id="chat-box">
        {% for msg in messages %}
            <p><b>{{ msg.sender.username }}:</b> {{ msg.text }}</p>
        {% endfor %}
    </div>

    <div class="chat-input-container">
        <input id="message-input" type="text" placeholder="Type your message..." autocomplete="off">
        <button id="send-btn">Send</button>
    </div>
</div>

<script>
const roomId = "{{ room.id }}";

const protocol = window.location.protocol === "https:" ? "wss" : "ws";

const socket = new WebSocket(
  `${protocol}://${window.location.host}/ws/chat/${roomId}/`
);

socket.onopen = function () {
  console.log("‚úÖ WebSocket connected");
};

socket.onmessage = function (e) {
  const data = JSON.parse(e.data);
  const chatBox = document.getElementById("chat-box");

  chatBox.innerHTML += `
    <p><b>${data.user}:</b> ${data.message}</p>
  `;

  chatBox.scrollTop = chatBox.scrollHeight;
};

socket.onclose = function (e) {
  console.error("‚ùå WebSocket closed", e);
};

socket.onerror = function (e) {
  console.error("‚ùå WebSocket error", e);
};

document.getElementById("send-btn").onclick = function () {
  const input = document.getElementById("message-input");
  const msg = input.value.trim();

  if (msg !== "") {
    socket.send(JSON.stringify({ message: msg }));
    input.value = "";
  }
};
</script>


{% endblock %}